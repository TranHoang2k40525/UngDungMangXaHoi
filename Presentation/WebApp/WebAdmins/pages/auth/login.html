<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÄÄƒng nháº­p - Admin</title>
  <link rel="stylesheet" href="../../styles.css">
</head>
<body>
  <div class="container-center">
    <div class="card auth">
      <div class="logo">SNAP67CS Admin</div>

      <form id="loginForm">
        <input name="identifier" id="identifier" class="form-control" placeholder="Email hoáº·c Sá»‘ Ä‘iá»‡n thoáº¡i" required />
        <div style="position:relative">
          <input id="pwd" type="password" name="password" class="form-control" placeholder="Máº­t kháº©u" required />
          <button type="button" onclick="(function(){ const p=document.getElementById('pwd'); p.type = p.type==='password'?'text':'password'; })()" style="position:absolute;right:12px;top:8px;border:none;background:none;color:#9ca3af;">ğŸ‘ï¸</button>
        </div>

        <div class="auth-btn-wrap">
          <button class="btn-primary" type="submit" id="loginBtn" style="width:320px;max-width:86%;">ÄÄƒng nháº­p</button>
        </div>

        <div class="auth-links">
          <div>ChÆ°a cÃ³ tÃ i khoáº£n? <a href="register.html">ÄÄƒng kÃ½</a></div>
          <div style="margin-top:8px"><a href="forgot-password.html">QuÃªn máº­t kháº©u?</a></div>
        </div>

        <div id="msg" style="min-height:18px;margin-top:12px;color:var(--muted)"></div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { authAPI, adminAPI } from '../../API/Api.js';
    
    // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p khi load trang
    window.addEventListener('load', () => {
      if (authAPI.isAuthenticated()) {
        window.location.href = '../home/home.html';
      }
    });
    
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const loginBtn = document.getElementById('loginBtn');
      const msg = document.getElementById('msg');
      const originalText = loginBtn.textContent;
      
      try {
        loginBtn.textContent = 'Äang Ä‘Äƒng nháº­p...';
        loginBtn.disabled = true;
        msg.textContent = '';
        
        const identifier = document.getElementById('identifier').value;
        const password = document.getElementById('pwd').value;
        
        // XÃ¡c Ä‘á»‹nh email hoáº·c phone
        const credentials = {
          Email: identifier.includes('@') ? identifier : '',
          Phone: !identifier.includes('@') ? identifier : '',
          Password: password
        };
        
        // Gá»i API Ä‘Äƒng nháº­p
        const result = await authAPI.login(credentials);
        
        console.log('Login result:', result); // Debug
        console.log('Access token stored:', localStorage.getItem('accessToken')); // Debug
        
        // KIá»‚M TRA: Chá»‰ cho phÃ©p Admin Ä‘Äƒng nháº­p vÃ o Web Admin
        // Giáº£i mÃ£ token Ä‘á»ƒ láº¥y account_type
        const token = localStorage.getItem('accessToken');
        if (!token) {
          throw new Error('KhÃ´ng thá»ƒ láº¥y token Ä‘Äƒng nháº­p');
        }
        
        // Decode JWT token (pháº§n payload)
        const payload = JSON.parse(atob(token.split('.')[1]));
        const accountType = payload.account_type || payload.role;
        
        console.log('Account type:', accountType); // Debug
        
        // Kiá»ƒm tra account_type pháº£i lÃ  Admin
        if (accountType !== 'Admin') {
          // XÃ³a token
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          throw new Error('Chá»‰ tÃ i khoáº£n Admin má»›i cÃ³ thá»ƒ Ä‘Äƒng nháº­p vÃ o há»‡ thá»‘ng nÃ y. Vui lÃ²ng sá»­ dá»¥ng tÃ i khoáº£n Admin.');
        }
        
        // Äá»£i má»™t chÃºt Ä‘á»ƒ Ä‘áº£m báº£o token Ä‘Ã£ Ä‘Æ°á»£c lÆ°u
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Láº¥y thÃ´ng tin profile sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
        const profileInfo = await adminAPI.getProfile();
        
        console.log('Profile info:', profileInfo); // Debug
        
        // LÆ°u thÃ´ng tin admin vÃ o localStorage
        localStorage.setItem('adminInfo', JSON.stringify(profileInfo));
        
        msg.textContent = 'ÄÄƒng nháº­p thÃ nh cÃ´ng!';
        msg.style.color = 'green';
        
        setTimeout(() => {
          window.location.href = '../home/home.html';
        }, 1000);
        
      } catch (error) {
        msg.textContent = 'Lá»—i Ä‘Äƒng nháº­p: ' + error.message;
        msg.style.color = 'red';
      } finally {
        loginBtn.textContent = originalText;
        loginBtn.disabled = false;
      }
    });
  </script>
</body>
</html>