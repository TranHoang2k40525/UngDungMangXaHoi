<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Đổi mật khẩu - Admin</title>
  <link rel="stylesheet" href="../../styles.css">
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar">
      <div class="brand">SNAP67CS Admin</div>
      <div class="nav-list">
        <a class="nav-item" href="../home/home.html">Trang chủ Admin</a>
        <a class="nav-item" href="../users/users.html">Quản lý người dùng</a>
        <a class="nav-item" href="../moderation/moderation.html">Kiểm duyệt nội dung</a>
        <a class="nav-item" href="../reports/reports.html">Báo cáo vi phạm</a>
        <a class="nav-item" href="../ai/ai.html">Hệ thống AI</a>
        <a class="nav-item" href="../analytics/analytics.html">Thống kê & Phân tích</a>
        <a class="nav-item active" href="settings.html">Cài đặt</a>
      </div>
      <div class="sidebar-footer">
        <!-- Avatar + Account Info -->
        <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <img id="sidebarAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect fill='%236366F1' width='40' height='40'/%3E%3Ctext fill='%23fff' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='16' font-weight='600'%3EA%3C/text%3E%3C/svg%3E" 
                 alt="Avatar" 
                 style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
            <div style="flex: 1; min-width: 0;">
              <div id="sidebarFullName" style="color: #fff; font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                Loading...
              </div>
              <div id="sidebarEmail" style="color: rgba(255,255,255,0.7); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ...
              </div>
            </div>
          </div>
        </div>
        <a class="nav-item" href="#" id="logoutBtn">Logout</a>
      </div>
    </aside>

    <main class="main">
      <button onclick="history.back()" class="back-arrow" style="position:static;margin-bottom:16px;">←</button>
      
      <div class="card p-4" style="max-width:600px">
        <div style="margin-bottom:24px">
          <h2 style="margin:0;color:#111827;font-size:24px;font-weight:700">Đổi mật khẩu</h2>
          <p style="color:#6B7280;margin-top:8px">Nhập mật khẩu hiện tại và mật khẩu mới</p>
        </div>

        <form id="changePasswordForm">
          <input type="password" id="oldPassword" class="form-control" placeholder="Mật khẩu hiện tại" required>
          <input type="password" id="newPassword" class="form-control" placeholder="Mật khẩu mới (tối thiểu 8 ký tự)" required>
          <input type="password" id="confirmPassword" class="form-control" placeholder="Xác nhận mật khẩu mới" required>
          
          <div class="auth-btn-wrap" style="margin-top:20px">
            <button type="submit" class="btn-primary" id="submitBtn" style="width:100%">Đổi mật khẩu</button>
          </div>
          <div id="msg" style="min-height:18px;margin-top:12px;color:var(--muted)"></div>
        </form>
      </div>
    </main>
  </div>

  <script type="module">
    import { authAPI, adminAPI } from '../../API/Api.js';
    import { updateSidebarProfile } from '../../Context/SidebarHelper.js';
    
    // Kiểm tra đăng nhập
    if (!authAPI.isAuthenticated()) {
      window.location.href = '../auth/login.html';
    }
    
    // Load sidebar profile với avatar
    updateSidebarProfile(adminAPI);
    
    // Logout handler
    document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
      e.preventDefault();
      await authAPI.logout();
      window.location.href = '../auth/login.html';
    });
    
    // Xử lý submit form đổi mật khẩu
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const msg = document.getElementById('msg');
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.textContent = 'Đang xử lý...';
        submitBtn.disabled = true;
        msg.textContent = '';
        
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Kiểm tra mật khẩu khớp
        if (newPassword !== confirmPassword) {
          msg.textContent = 'Mật khẩu xác nhận không khớp!';
          msg.style.color = 'red';
          return;
        }
        
        // Kiểm tra độ dài
        if (newPassword.length < 8) {
          msg.textContent = 'Mật khẩu mới phải có ít nhất 8 ký tự!';
          msg.style.color = 'red';
          return;
        }
        
        // Gọi API để đổi mật khẩu (không cần OTP)
        const result = await adminAPI.changePasswordDirect({
          OldPassword: oldPassword,
          NewPassword: newPassword
        });
        
        msg.textContent = result.message || 'Đổi mật khẩu thành công!';
        msg.style.color = 'green';
        
        // Logout và chuyển về trang login
        setTimeout(async () => {
          await authAPI.logout();
          alert('Đổi mật khẩu thành công! Vui lòng đăng nhập lại.');
          window.location.href = '../auth/login.html';
        }, 2000);
        
      } catch (error) {
        msg.textContent = 'Lỗi: ' + error.message;
        msg.style.color = 'red';
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    
    // Xử lý logout
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      await authAPI.logout();
      window.location.href = '../auth/login.html';
    });
  </script>
</body>
</html>
