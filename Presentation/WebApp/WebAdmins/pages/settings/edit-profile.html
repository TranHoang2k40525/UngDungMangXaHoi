<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ch·ªânh s·ª≠a th√¥ng tin - Admin</title>
  <link rel="stylesheet" href="../../styles.css">
</head>
<body>
  <div class="app-layout">
    <aside class="sidebar">
      <div class="brand">MediaLite Admin</div>
      <div class="nav-list">
        <a class="nav-item" href="../home/home.html">Trang ch·ªß Admin</a>
        <a class="nav-item" href="../users/users.html">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        <a class="nav-item" href="../moderation/moderation.html">Ki·ªÉm duy·ªát n·ªôi dung</a>
        <a class="nav-item" href="../reports/reports.html">B√°o c√°o vi ph·∫°m</a>
        <a class="nav-item" href="../ai/ai.html">H·ªá th·ªëng AI</a>
        <a class="nav-item" href="../analytics/analytics.html">Th·ªëng k√™ & Ph√¢n t√≠ch</a>
        <a class="nav-item active" href="settings.html">C√†i ƒë·∫∑t</a>
      </div>
      <div class="sidebar-footer">
        <!-- Avatar + Account Info -->
        <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <img id="sidebarAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect fill='%236366F1' width='40' height='40'/%3E%3Ctext fill='%23fff' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='16' font-weight='600'%3EA%3C/text%3E%3C/svg%3E" 
                 alt="Avatar" 
                 style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
            <div style="flex: 1; min-width: 0;">
              <div id="sidebarFullName" style="color: #fff; font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                Loading...
              </div>
              <div id="sidebarEmail" style="color: rgba(255,255,255,0.7); font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ...
              </div>
            </div>
          </div>
        </div>
        <a class="nav-item" href="#" id="logoutBtn">Logout</a>
      </div>
    </aside>

    <main class="main">
      <button onclick="history.back()" class="back-arrow" style="position:static;margin-bottom:16px;">‚Üê</button>
      
      <div class="card p-4">
        <div style="margin-bottom:24px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin:0;color:#111827;font-size:24px;font-weight:700">Th√¥ng tin c√° nh√¢n</h2>
            <p style="color:#6B7280;margin-top:8px">Xem v√† c·∫≠p nh·∫≠t th√¥ng tin c·ªßa b·∫°n</p>
          </div>
          <button type="button" id="editBtn" class="btn-primary" style="height: 40px; padding: 0 24px;">
            Ch·ªânh s·ª≠a
          </button>
        </div>

        <form id="profileForm">
          <!-- Avatar Upload -->
          <div style="margin-bottom: 24px; text-align: center;">
            <div style="position: relative; display: inline-block;">
              <img id="avatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%23E5E7EB' width='120' height='120'/%3E%3Ctext fill='%236B7280' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='48' font-weight='600'%3E%3F%3C/text%3E%3C/svg%3E" 
                   alt="Avatar" 
                   style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #E5E7EB;">
              <label for="avatarInput" id="avatarUploadBtn" style="position: absolute; bottom: 0; right: 0; background: #6366F1; color: white; width: 36px; height: 36px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </label>
              <input type="file" id="avatarInput" accept="image/*" style="display: none;" disabled>
            </div>
          </div>

          <!-- Basic Info -->
          <div style="margin-bottom: 16px;">
            <h3 style="color: #111827; font-size: 16px; font-weight: 600; margin-bottom: 12px;">Th√¥ng tin c∆° b·∫£n</h3>
          </div>
          
          <div class="form-row">
            <input type="text" id="fullName" class="form-control" placeholder="H·ªç v√† t√™n *" required readonly>
            <input type="text" id="email" class="form-control" placeholder="Email" disabled readonly style="background:#F3F4F6">
          </div>
          
          <div class="form-row">
            <input type="tel" id="phone" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i" readonly>
            <input type="date" id="dateOfBirth" class="form-control" readonly>
          </div>

          <div class="form-row">
            <select id="gender" class="form-control" style="height:46px;border-radius:10px" disabled>
              <option value="">Gi·ªõi t√≠nh</option>
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
              <option value="Kh√°c">Kh√°c</option>
            </select>
            <select id="adminLevel" class="form-control" style="height:46px;border-radius:10px" disabled>
              <option value="">C·∫•p qu·∫£n tr·ªã</option>
              <option value="super_admin">Super Admin</option>
              <option value="admin">Admin</option>
              <option value="moderator">Moderator</option>
            </select>
          </div>
          
          <!-- Additional Info -->
          <div style="margin: 24px 0 16px;">
            <h3 style="color: #111827; font-size: 16px; font-weight: 600; margin-bottom: 12px;">Th√¥ng tin b·ªï sung</h3>
          </div>
          
          <div class="form-row">
            <input type="text" id="job" class="form-control" placeholder="Ngh·ªÅ nghi·ªáp" readonly>
            <input type="text" id="website" class="form-control" placeholder="Website" readonly>
          </div>
          
          <input type="text" id="address" class="form-control" placeholder="ƒê·ªãa ch·ªâ" readonly>
          <input type="text" id="hometown" class="form-control" placeholder="Qu√™ qu√°n" readonly>
          <textarea id="bio" class="form-control" placeholder="Gi·ªõi thi·ªáu b·∫£n th√¢n" rows="4" style="resize:vertical" readonly></textarea>
          
          <!-- Privacy -->
          <div style="margin: 24px 0 16px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;" id="privacyLabel">
              <input type="checkbox" id="isPrivate" style="width: 18px; height: 18px; cursor: pointer;" disabled>
              <span style="color: #374151; font-size: 14px;">ƒê·∫∑t t√†i kho·∫£n ·ªü ch·∫ø ƒë·ªô ri√™ng t∆∞</span>
            </label>
          </div>
          
          <div class="auth-btn-wrap" style="margin-top:20px; display:none" id="submitBtnWrap">
            <button type="submit" class="btn-primary" id="submitBtn" style="width:100%">C·∫≠p nh·∫≠t th√¥ng tin</button>
          </div>
          <div id="msg" style="min-height:18px;margin-top:12px;color:var(--muted)"></div>
        </form>
      </div>
    </main>
  </div>

  <script type="module">
    import { authAPI, adminAPI } from '../../API/Api.js';
    
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    if (!authAPI.isAuthenticated()) {
      window.location.href = '../auth/login.html';
    }
    
    let currentAvatarUrl = '';
    let avatarChanged = false; // Track n·∫øu avatar ƒë√£ thay ƒë·ªïi
    let isEditMode = false; // Track edit mode
    
    // Toggle edit mode
    document.getElementById('editBtn').addEventListener('click', () => {
      isEditMode = !isEditMode;
      const editBtn = document.getElementById('editBtn');
      const submitBtnWrap = document.getElementById('submitBtnWrap');
      const avatarUploadBtn = document.getElementById('avatarUploadBtn');
      const avatarInput = document.getElementById('avatarInput');
      
      if (isEditMode) {
        // Switch to edit mode
        editBtn.textContent = 'H·ªßy';
        editBtn.style.background = '#EF4444';
        submitBtnWrap.style.display = 'block';
        avatarUploadBtn.style.display = 'flex';
        avatarInput.disabled = false;
        
        // Enable all inputs except email and adminLevel
        document.getElementById('fullName').removeAttribute('readonly');
        document.getElementById('phone').removeAttribute('readonly');
        document.getElementById('dateOfBirth').removeAttribute('readonly');
        document.getElementById('gender').removeAttribute('disabled');
        document.getElementById('job').removeAttribute('readonly');
        document.getElementById('website').removeAttribute('readonly');
        document.getElementById('address').removeAttribute('readonly');
        document.getElementById('hometown').removeAttribute('readonly');
        document.getElementById('bio').removeAttribute('readonly');
        document.getElementById('isPrivate').removeAttribute('disabled');
        
      } else {
        // Return to view mode (reload page)
        window.location.reload();
      }
    });
    
    // Load th√¥ng tin profile
    async function loadProfile() {
      try {
        const profile = await adminAPI.getProfile();
        
        // Load form fields
        document.getElementById('fullName').value = profile.fullName || '';
        document.getElementById('email').value = profile.email || '';
        document.getElementById('phone').value = profile.phone || '';
        
        if (profile.dateOfBirth) {
          const date = new Date(profile.dateOfBirth);
          document.getElementById('dateOfBirth').value = date.toISOString().split('T')[0];
        }
        
        document.getElementById('gender').value = profile.gender || '';
        document.getElementById('job').value = profile.job || '';
        document.getElementById('address').value = profile.address || '';
        document.getElementById('hometown').value = profile.hometown || '';
        document.getElementById('website').value = profile.website || '';
        document.getElementById('bio').value = profile.bio || '';
        document.getElementById('adminLevel').value = profile.adminLevel || '';
        document.getElementById('isPrivate').checked = profile.isPrivate || false;
        
        // Load avatar with SVG fallback
        currentAvatarUrl = profile.avatarUrl || '';
        const firstLetter = (profile.fullName || 'A').charAt(0).toUpperCase();
        const defaultAvatar = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%236366F1' width='120' height='120'/%3E%3Ctext fill='white' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='48' font-weight='600'%3E${firstLetter}%3C/text%3E%3C/svg%3E`;
        const avatarUrl = currentAvatarUrl || defaultAvatar;
        document.getElementById('avatarPreview').src = avatarUrl;
        
        // Load sidebar info
        updateSidebarInfo(profile);
        
      } catch (error) {
        console.error('L·ªói khi t·∫£i th√¥ng tin:', error);
        document.getElementById('msg').textContent = 'L·ªói khi t·∫£i th√¥ng tin: ' + error.message;
        document.getElementById('msg').style.color = 'red';
      }
    }
    
    // C·∫≠p nh·∫≠t th√¥ng tin sidebar
    function updateSidebarInfo(profile) {
      const sidebarAvatar = document.getElementById('sidebarAvatar');
      const sidebarFullName = document.getElementById('sidebarFullName');
      const sidebarEmail = document.getElementById('sidebarEmail');
      
      const firstLetter = (profile.fullName || 'A').charAt(0).toUpperCase();
      const defaultAvatar = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect fill='%236366F1' width='40' height='40'/%3E%3Ctext fill='white' x='50%25' y='50%25' text-anchor='middle' dy='.3em' font-size='20' font-weight='600'%3E${firstLetter}%3C/text%3E%3C/svg%3E`;
      
      if (sidebarAvatar) {
        sidebarAvatar.src = profile.avatarUrl || defaultAvatar;
      }
      if (sidebarFullName) {
        sidebarFullName.textContent = profile.fullName || 'Admin User';
      }
      if (sidebarEmail) {
        sidebarEmail.textContent = profile.email || '';
      }
    }
    
    // Chuy·ªÉn file ·∫£nh th√†nh Base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // Compress ·∫£nh n·∫øu qu√° l·ªõn
    async function compressImage(file, maxWidth = 400, maxHeight = 400, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // T√≠nh to√°n k√≠ch th∆∞·ªõc m·ªõi gi·ªØ t·ª∑ l·ªá
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to Base64
            const base64 = canvas.toDataURL('image/jpeg', quality);
            resolve(base64);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
    
    // X·ª≠ l√Ω upload avatar
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('File ·∫£nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 5MB.');
        e.target.value = ''; // Reset input
        return;
      }
      
      // Ki·ªÉm tra ƒë·ªãnh d·∫°ng
      if (!file.type.startsWith('image/')) {
        alert('Vui l√≤ng ch·ªçn file ·∫£nh (JPG, PNG)');
        e.target.value = '';
        return;
      }
      
      try {
        // Hi·ªÉn th·ªã loading
        const preview = document.getElementById('avatarPreview');
        const originalSrc = preview.src;
        preview.style.opacity = '0.5';
        
        // Compress ·∫£nh v√† chuy·ªÉn th√†nh Base64
        const base64 = await compressImage(file, 400, 400, 0.8);
        
        // Preview ·∫£nh
        preview.src = base64;
        preview.style.opacity = '1';
        
        // L∆∞u v√†o bi·∫øn ƒë·ªÉ submit sau
        currentAvatarUrl = base64;
        avatarChanged = true;
        
        console.log('‚úÖ ·∫¢nh ƒë√£ ƒë∆∞·ª£c ch·ªçn v√† compress:', {
          originalSize: (file.size / 1024).toFixed(2) + ' KB',
          base64Size: (base64.length / 1024).toFixed(2) + ' KB',
          format: file.type
        });
        
      } catch (error) {
        console.error('L·ªói khi x·ª≠ l√Ω ·∫£nh:', error);
        alert('L·ªói khi x·ª≠ l√Ω ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
        e.target.value = '';
      }
    });
    
    // Load profile khi trang ƒë∆∞·ª£c t·∫£i
    loadProfile();
    
    // X·ª≠ l√Ω submit form
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const msg = document.getElementById('msg');
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.textContent = avatarChanged ? 'ƒêang t·∫£i ·∫£nh l√™n...' : 'ƒêang c·∫≠p nh·∫≠t...';
        submitBtn.disabled = true;
        msg.textContent = '';
        
        const formData = {
          FullName: document.getElementById('fullName').value,
          Phone: document.getElementById('phone').value,
          DateOfBirth: document.getElementById('dateOfBirth').value,
          Gender: document.getElementById('gender').value,
          Job: document.getElementById('job').value,
          Address: document.getElementById('address').value,
          Hometown: document.getElementById('hometown').value,
          Website: document.getElementById('website').value,
          Bio: document.getElementById('bio').value,
          IsPrivate: document.getElementById('isPrivate').checked,
          AvatarUrl: currentAvatarUrl // G·ª≠i Base64 ho·∫∑c URL hi·ªán t·∫°i
        };
        
        console.log('üì§ ƒêang g·ª≠i d·ªØ li·ªáu:', {
          ...formData,
          AvatarUrl: avatarChanged ? 'Base64 image (compressed)' : 'Unchanged'
        });
        
        const result = await adminAPI.updateProfile(formData);
        
        msg.textContent = result.message || 'C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!';
        msg.style.color = 'green';
        
        // Reset avatar changed flag
        avatarChanged = false;
        
        // Reload profile ƒë·ªÉ c·∫≠p nh·∫≠t sidebar
        await loadProfile();
        
        console.log('‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        
        // T·ª± ƒë·ªông chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô xem sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng
        setTimeout(() => {
          isEditMode = false;
          const editBtn = document.getElementById('editBtn');
          const submitBtnWrap = document.getElementById('submitBtnWrap');
          const avatarUploadBtn = document.getElementById('avatarUploadBtn');
          const avatarInput = document.getElementById('avatarInput');
          
          // Switch back to view mode
          editBtn.textContent = 'Ch·ªânh s·ª≠a';
          editBtn.style.background = '#6366F1';
          submitBtnWrap.style.display = 'none';
          avatarUploadBtn.style.display = 'none';
          avatarInput.disabled = true;
          
          // Disable all inputs
          document.getElementById('fullName').setAttribute('readonly', 'readonly');
          document.getElementById('phone').setAttribute('readonly', 'readonly');
          document.getElementById('dateOfBirth').setAttribute('readonly', 'readonly');
          document.getElementById('gender').setAttribute('disabled', 'disabled');
          document.getElementById('job').setAttribute('readonly', 'readonly');
          document.getElementById('website').setAttribute('readonly', 'readonly');
          document.getElementById('address').setAttribute('readonly', 'readonly');
          document.getElementById('hometown').setAttribute('readonly', 'readonly');
          document.getElementById('bio').setAttribute('readonly', 'readonly');
          document.getElementById('isPrivate').setAttribute('disabled', 'disabled');
          
          // X√≥a th√¥ng b√°o sau khi chuy·ªÉn v·ªÅ view mode
          msg.textContent = '';
        }, 1500);
        
      } catch (error) {
        console.error('‚ùå L·ªói c·∫≠p nh·∫≠t:', error);
        msg.textContent = 'L·ªói: ' + error.message;
        msg.style.color = 'red';
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    
    // X·ª≠ l√Ω logout
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      await authAPI.logout();
      window.location.href = '../auth/login.html';
    });
  </script>
</body>
</html>